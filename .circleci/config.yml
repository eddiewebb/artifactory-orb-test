
version: 2.1
orbs:
  artifactory: sandbox/artifactory@volatile

jobs:
  use-commands:
    docker:
      - image: circleci/openjdk:8
      - image: docker.bintray.io/jfrog/artifactory-oss:latest
    steps:
      - setup-rt

      - artifactory/install
      - artifactory/configure
      - run: echo "not a jar" >> artifact.jar
      - artifactory/upload:
          source: artifact.jar
          target: example-repo-local/my-asset
          build-name: ${CIRCLE_BUILD_NUM}
      - artifactory/build-integration:
          build-name: ${CIRCLE_BUILD_NUM}

workflows:
  version: 2
  test-orb:
    jobs:
      - use-commands
      # cant use job level in testing until we have hosted artiactory, or custom executors
      #- artifactory/upload:
      #    name: Test Upload
      #    source: test/artifact.jar
      #    target: repo/path
      #    build-steps:
      #      - run: mvn install -B
      #    pre-steps:
      #      - setup-rt


commands:
  setup-rt:
    description: Wait for Artifactory to intialize
    steps:
      - run:
          name: Initialize Artifactory Image
          command: |
            dockerize -wait tcp://localhost:8081 -timeout 1m
            #wait for artifactory to finish startup stuff
            while true; do
              STATUS=`curl -uadmin:password  http://localhost:8081/artifactory/api/system/ping 2>/dev/null`
              if [ "$STATUS" = "OK" ];then
                exit 0
              fi
              sleep 2
            done
      - run: echo "export ARTIFACTORY_URL=http://localhost:8081/artifactory" >> $BASH_ENV
      - run: echo "export ARTIFACTORY_API_KEY=$(curl -uadmin:password -X POST http://localhost:8081/artifactory/api/security/apiKey | jq -r '.apiKey')" >> $BASH_ENV


